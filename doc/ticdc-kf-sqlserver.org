* Overview
[[./png/roadmap.png]]
#+BEGIN_COMMENT
#+BEGIN_SRC plantuml :file ./png/roadmap.png
[JDBC sink] as jdbcsink
[TiDB] -> [TiCDC]
[TiCDC] -> [Confluent]
[Confluent] -> [jdbcsink]
[jdbcsink] -> [SQLServer]
#+END_SRC
#+END_COMMENT
** TiDB -> Aurora -> SQLServer
   [[./png/tidb2aurora2sqlserver.png]]
#+BEGIN_COMMENT
#+BEGIN_SRC plantuml :file ./png/tidb2aurora2sqlserver.png
[TiDB] -> [TiCDC]
[TiCDC] -> [Aurora]
[Aurora] -> [DMS]
[DMS] -> [SQLServer]
#+END_SRC
#+END_COMMENT
* TiDB install
** EC2 preparation
   + 1 TiDB nodes
   + 3 TiKV nodes
   + 3 TiPD nodes
   + 2 TiCDC nodes
*** VPC
#+BEGIN_SRC
$ aws ec2 create-vpc --cidr-block 172.50.0.0/16 --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=ticdc2sqlserver}]'
{
    "Vpc": {
        "CidrBlock": "172.50.0.0/16",
        "DhcpOptionsId": "dopt-d74aa6b0",
        "State": "pending",
        "VpcId": "vpc-0bc1317fe40867335",
        "OwnerId": "385595570414",
        "InstanceTenancy": "default",
        "Ipv6CidrBlockAssociationSet": [],
        "CidrBlockAssociationSet": [
            {
                "AssociationId": "vpc-cidr-assoc-07abe66172c340e4a",
                "CidrBlock": "172.50.0.0/16",
                "CidrBlockState": {
                    "State": "associated"
                }
            }
        ],
        "IsDefault": false,
        "Tags": [
            {
                "Key": "Name",
                "Value": "ticdc2sqlserver"
            }
        ]
    }
}
#+END_SRC
*** subnets
#+BEGIN_SRC
$ aws ec2 create-subnet --cidr-block 172.50.10.0/24 \
                        --vpc-id vpc-0bc1317fe40867335 \
                        --availability-zone=ap-northeast-1a \
                        --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=ticdc2sqlserver},{Key=id,Value=1}]'
$ aws ec2 create-subnet --cidr-block 172.50.20.0/24 \
                        --vpc-id vpc-0bc1317fe40867335 \
                        --availability-zone=ap-northeast-1c \
                        --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=ticdc2sqlserver},{Key=id,Value=2}]'
$ aws ec2 create-subnet --cidr-block 172.50.30.0/24 \
                        --vpc-id vpc-0bc1317fe40867335 \
                        --availability-zone=ap-northeast-1d \
                        --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=ticdc2sqlserver},{Key=id,Value=3}]'
#+END_SRC
*** route table
#+BEGIN_SRC
$ aws ec2 create-route-table --vpc-id vpc-0bc1317fe40867335 --tag-specification 'ResourceType=route-table,Tags=[{Key=Name,Value=ticdc2sqlserver}]'
{            
    "RouteTable": {
        "Associations": [],
        "PropagatingVgws": [],
        "RouteTableId": "rtb-0b0a9d68a7aceee93",                                                      
        "Routes": [
            {
                "DestinationCidrBlock": "172.50.0.0/16",
                "GatewayId": "local",
                "Origin": "CreateRouteTable",
                "State": "active"
            }
        ],
        "Tags": [
            {
                "Key": "Name",
                "Value": "ticdc2sqlserver"
            }
        ],
        "VpcId": "vpc-0bc1317fe40867335",
        "OwnerId": "385595570414"
    }
}
$ aws ec2 associate-route-table --route-table-id rtb-0b0a9d68a7aceee93 --subnet-id subnet-01dffc3b1b6eb1758
{
    "AssociationId": "rtbassoc-0d34b2dc4aa46dd82",
    "AssociationState": {
        "State": "associated"
    }
}
$ aws ec2 associate-route-table --route-table-id rtb-0b0a9d68a7aceee93 --subnet-id subnet-0b6412d0791ba770e
{
    "AssociationId": "rtbassoc-0a9d9b119a8e92d68",
    "AssociationState": {
        "State": "associated"
    }
}
$ aws ec2 associate-route-table --route-table-id rtb-0b0a9d68a7aceee93 --subnet-id subnet-02730e7393d36fefc
{
    "AssociationId": "rtbassoc-0580cb8fdad9bbfd0",
    "AssociationState": {
        "State": "associated"
    }
}
#+END_SRC
*** internet gateway
#+BEGIN_SRC
$ aws ec2 create-internet-gateway --tag-specification 'ResourceType=internet-gateway,Tags=[{Key=Name,Value=ticdc2sqlserver}]'
{
    "InternetGateway": {
        "Attachments": [],
        "InternetGatewayId": "igw-08988fd163c7abe49",
        "OwnerId": "385595570414",
        "Tags": [
            {
                "Key": "Name",
                "Value": "ticdc2sqlserver"
            }
        ]
    }
}
$ aws ec2 attach-internet-gateway --internet-gateway-id igw-08988fd163c7abe49 --vpc-id vpc-0bc1317fe40867335
$ aws ec2 create-route --route-table-id rtb-0b0a9d68a7aceee93 --destination-cidr-block 0.0.0.0/0 --gateway-id igw-08988fd163c7abe49
{
    "Return": true
}
$ aws ec2 modify-vpc-attribute --vpc-id vpc-0bc1317fe40867335 --enable-dns-hostnames
$ aws ec2 modify-vpc-attribute --vpc-id vpc-0bc1317fe40867335 --enable-dns-support
#+END_SRC
*** Security group
#+BEGIN_SRC
$ aws ec2 create-security-group --group-name ticdc2sqlserver-ws \
                                --vpc-id vpc-0bc1317fe40867335 \
                                --description "ticdc2sqlserver" \
                                --tag-specification 'ResourceType=security-group,Tags=[{Key=Name,Value=ticdc2sqlserver}]'
{
    "GroupId": "sg-0a43a669d4f301c39",
    "Tags": [
        {
            "Key": "Name",
            "Value": "ticdc2sqlserver"
        }
    ]
}

$ aws ec2 authorize-security-group-ingress \
--group-id sg-0a43a669d4f301c39 \
--protocol tcp \
--port 22 \
--cidr 0.0.0.0/0
{
    "GroupId": "sg-0a43a669d4f301c39",
    "Tags": [
        {
            "Key": "Name",
            "Value": "ticdc2sqlserver"
        }
    ]
}

$ aws ec2 authorize-security-group-ingress \
--group-id sg-0a43a669d4f301c39 \
--protocol tcp \
--port 0-65535 \
--cidr 0.0.0.0/0
#+END_SRC
*** EC2 preparation
    + One workstation
#+BEGIN_SRC
$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.large \
--associate-public-ip-address \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-01dffc3b1b6eb1758 \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-ws}]'

$ssh -i "~/.ssh/jaypingcap.pem" admin@54.150.246.155

$ sudo tee /etc/apt/sources.list<<EOF
deb http://deb.debian.org/debian/ buster main
deb-src http://deb.debian.org/debian/ buster main

deb http://deb.debian.org/debian/ buster-updates main
deb-src http://deb.debian.org/debian/ buster-updates main

deb http://security.debian.org/debian-security buster/updates main
deb-src http://security.debian.org/debian-security buster/updates main
EOF

$ sudo apt-get -y update
$ sudo apt-get install rsync

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.xlarge \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-01dffc3b1b6eb1758 \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-node01}, {Key=clusterName, Value=ticdcsqlserver}]'

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.xlarge \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-0b6412d0791ba770e \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-node02}, {Key=clusterName, Value=ticdcsqlserver}]'

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.xlarge \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-02730e7393d36fefc \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-node03}, {Key=clusterName, Value=ticdcsqlserver}]'

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.large \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-01dffc3b1b6eb1758 \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-kf01}, {Key=clusterName, Value=ticdcsqlserver}]'

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.large \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-0b6412d0791ba770e \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-kf02}, {Key=clusterName, Value=ticdcsqlserver}]'

$ aws ec2 run-instances \
--count 1 \
--image-id ami-0ac97798ccf296e02 \
--instance-type t2.large \
--key-name jay.pingcap \
--security-group-ids sg-0a43a669d4f301c39 \
--subnet-id subnet-02730e7393d36fefc \
--region ap-northeast-1 \
--block-device-mapping '[ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": 30 } } ]' \
--tag-specification 'ResourceType=instance,Tags=[{Key=Name,Value=ticdc2sqlserver-kf03}, {Key=clusterName, Value=ticdcsqlserver}]'
#+END_SrC
    + Three TiDB
** TiUP deployment
*** TiUP binary install
#+BEGIN_SRC
$ curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
$ source ~/.bashrc
$ more topology.yaml
global:
  user: "admin"
  ssh_port: 22
  deploy_dir: "/home/admin/tidb-deploy"
  data_dir: "/home/admin/tidb-data"

monitored:
  node_exporter_port: 9100
  blackbox_exporter_port: 9115

server_configs:
  tidb:
    log.slow-threshold: 300
  tikv:
    readpool.storage.use-unified-pool: false
    readpool.coprocessor.use-unified-pool: true
  pd:
    schedule.leader-schedule-limit: 4
    schedule.region-schedule-limit: 2048
    schedule.replica-schedule-limit: 64
  cdc:

pd_servers:
  - host: 172.50.10.141
  - host: 172.50.20.102
  - host: 172.50.30.250

tidb_servers:
  - host: 172.50.10.141
  - host: 172.50.20.102
  - host: 172.50.30.250

tikv_servers:
  - host: 172.50.10.141
  - host: 172.50.20.102
  - host: 172.50.30.250

cdc_servers:
  - host: 172.50.10.141
  - host: 172.50.20.102
  - host: 172.50.30.250

monitoring_servers:
  - host: 172.50.10.141

grafana_servers:
  - host: 172.50.10.141

alertmanager_servers:
  - host: 172.50.10.141

#+END_SRC
* Confluent install
** Self managment
*** Binary download
#+BEGIN_SRC
$ wget http://packages.confluent.io/archive/5.2/confluent-5.2.3-2.12.tar.gz
$ tar xvf confluent-5.2.3-2.12.tar.gz
$ export CONFLUENT_HOME=$(pwd)/confluent-5.2.3
$ export PATH=$PATH:$CONFLUENT_HOME/bin
$ sed -i 's|^dataDir=\(.*\)|dataDir=/home/admin/confluent/zookeeper|g' confluent-5.2.3/etc/kafka/zookeeper.propertie
$ mkdir -p /home/admin/confluent/zookeeper
$ sed -i 's|^log.dirs=\(.*\)|log.dirs=/home/admin/confluent/kafka/data|g' confluent-5.2.3/etc/kafka/server.properties
$ mkdir -p /home/admin/confluent/kafka/data
$ sudo apt-get install -y openjdk-11-jdk
#+END_SRC
*** Install
*** Deployment
#+BEGIN_SRC
$ tiup cdc cli changefeed remove --pd="http://172.50.10.141:2379" -c df3aa6e8-691c-413a-8d45-1ea8eefaab0d
Starting component `cdc`: /home/admin/.tiup/components/cdc/v5.2.1/cdc cli changefeed remove --pd=http://172.50.10.141:2379 -c df3aa6e8-691c-413a-8d45-1ea8eefaab0d

$ tiup cdc cli changefeed create --pd="http://172.50.10.141:2379" --sink-uri="kafka://172.50.10.202:9092/test?protocol=avro" --opts "registry=http://172.50.10.202:8081
Starting component `cdc`: /home/admin/.tiup/components/cdc/v5.2.1/cdc cli changefeed create --pd=http://172.50.10.141:2379 --sink-uri=kafka://172.50.10.202:9092/test?protocol=avro --opts registr
Create changefeed successfully!
ID: ffe98a1c-ef60-4ea7-baad-8fb371a4214a
Info: {"sink-uri":"kafka://172.50.10.202:9092/test?protocol=avro","opts":{"registry":"http://172.50.10.202:8081"},"create-time":"2021-10-15T02:02:27.55378369Z","start-ts":428412330966777857,"target-ts":0,"admin-job-type":0,"sort-engine":"unified","sort-dir":"","config":{"case-sensitive":true,"enable-old-value":true,"force-replicate":false,"check-gc-safe-point":true,"filter":{"rules":["*.*"],"ignore-txn-start-ts":null},"mounter":{"worker-num":16},"sink":{"dispatchers":null,"protocol":"avro"},"cyclic-replication":{"enable":false,"replica-id":0,"filter-replica-ids":null,"id-buckets":0,"sync-ddl":false},"scheduler":{"type":"table-number","polling-time":-1}},"state":"normal","history":null,"error":null,"sync-point-enabled":false,"sync-point-interval":600000000000,"creator-version":"v5.2.1"}

$ tiup cdc cli changefeed list --pd=http://172.50.10.141:2379
Starting component `cdc`: /home/admin/.tiup/components/cdc/v5.2.1/cdc cli changefeed list --pd=http://172.50.10.141:2379
[
  {
    "id": "ffe98a1c-ef60-4ea7-baad-8fb371a4214a",
    "summary": {
      "state": "normal",
      "tso": 428412340063436802,
      "checkpoint": "2021-10-15 02:03:02.200",
      "error": null
    }
  }
]

$ tiup cdc cli changefeed create --pd="http://172.50.10.141:2379" --sink-uri="mysql://master:1234Abcd@172.10.10.118:3306"

$ tiup cdc cli changefeed list --pd=http://172.50.10.141:2379

#+END_SRC

#+BEGIN_SRC
$curl -X POST -H "Content-Type: application/json" -d @jdbc-sink-connector.json http://127.0.0.1:8083/connectors
#+END_SRC
** Services
* SQL server install
#+BEGIN_SRC
https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-setup-tools?view=sql-server-ver15

apt-get install gnupg2
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
curl https://packages.microsoft.com/config/ubuntu/16.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
sudo apt-get update
sudo apt-get install mssql-tools unixodbc-dev
echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
(%ZS8v6U3;
#+END_SRC


* QPS test


https://github.com/Percona-Lab/ontime-airline-performance/blob/master/mysql/create_table.sql

#+BEGIN_SRC
CREATE TABLE `ontime` (
   id bigint primary key auto_random, 
  `Year` year(4) DEFAULT NULL,
  `Quarter` tinyint(4) DEFAULT NULL,
  `Month` tinyint(4) DEFAULT NULL,
  `DayofMonth` tinyint(4) DEFAULT NULL,
  `DayOfWeek` tinyint(4) DEFAULT NULL,
  `FlightDate` date DEFAULT NULL,
  `UniqueCarrier` char(7) DEFAULT NULL,
  `AirlineID` int(11) DEFAULT NULL,
  `Carrier` char(2) DEFAULT NULL,
  `TailNum` varchar(50) DEFAULT NULL,
  `FlightNum` varchar(10) DEFAULT NULL,
  `OriginAirportID` int(11) DEFAULT NULL,
  `OriginAirportSeqID` int(11) DEFAULT NULL,
  `OriginCityMarketID` int(11) DEFAULT NULL,
  `Origin` char(5) DEFAULT NULL,
  `OriginCityName` varchar(100) DEFAULT NULL,
  `OriginState` char(2) DEFAULT NULL,
  `OriginStateFips` varchar(10) DEFAULT NULL,
  `OriginStateName` varchar(100) DEFAULT NULL,
  `OriginWac` int(11) DEFAULT NULL,
  `DestAirportID` int(11) DEFAULT NULL,
  `DestAirportSeqID` int(11) DEFAULT NULL,
  `DestCityMarketID` int(11) DEFAULT NULL,
  `Dest` char(5) DEFAULT NULL,
  `DestCityName` varchar(100) DEFAULT NULL,
  `DestState` char(2) DEFAULT NULL,
  `DestStateFips` varchar(10) DEFAULT NULL,
  `DestStateName` varchar(100) DEFAULT NULL,
  `DestWac` int(11) DEFAULT NULL,
  `CRSDepTime` int(11) DEFAULT NULL,
  `DepTime` int(11) DEFAULT NULL,
  `DepDelay` int(11) DEFAULT NULL,
  `DepDelayMinutes` int(11) DEFAULT NULL,
  `DepDel15` int(11) DEFAULT NULL,
  `DepartureDelayGroups` int(11) DEFAULT NULL,
  `DepTimeBlk` varchar(20) DEFAULT NULL,
  `TaxiOut` int(11) DEFAULT NULL,
  `WheelsOff` int(11) DEFAULT NULL,
  `WheelsOn` int(11) DEFAULT NULL,
  `TaxiIn` int(11) DEFAULT NULL,
  `CRSArrTime` int(11) DEFAULT NULL,
  `ArrTime` int(11) DEFAULT NULL,
  `ArrDelay` int(11) DEFAULT NULL,
  `ArrDelayMinutes` int(11) DEFAULT NULL,
  `ArrDel15` int(11) DEFAULT NULL,
  `ArrivalDelayGroups` int(11) DEFAULT NULL,
  `ArrTimeBlk` varchar(20) DEFAULT NULL,
  `Cancelled` tinyint(4) DEFAULT NULL,
  `CancellationCode` char(1) DEFAULT NULL,
  `Diverted` tinyint(4) DEFAULT NULL,
  `CRSElapsedTime` int(11) DEFAULT NULL,
  `ActualElapsedTime` int(11) DEFAULT NULL,
  `AirTime` int(11) DEFAULT NULL,
  `Flights` int(11) DEFAULT NULL,
  `Distance` int(11) DEFAULT NULL,
  `DistanceGroup` tinyint(4) DEFAULT NULL,
  `CarrierDelay` int(11) DEFAULT NULL,
  `WeatherDelay` int(11) DEFAULT NULL,
  `NASDelay` int(11) DEFAULT NULL,
  `SecurityDelay` int(11) DEFAULT NULL,
  `LateAircraftDelay` int(11) DEFAULT NULL,
  `FirstDepTime` varchar(10) DEFAULT NULL,
  `TotalAddGTime` varchar(10) DEFAULT NULL,
  `LongestAddGTime` varchar(10) DEFAULT NULL,
  `DivAirportLandings` varchar(10) DEFAULT NULL,
  `DivReachedDest` varchar(10) DEFAULT NULL,
  `DivActualElapsedTime` varchar(10) DEFAULT NULL,
  `DivArrDelay` varchar(10) DEFAULT NULL,
  `DivDistance` varchar(10) DEFAULT NULL,
  `Div1Airport` varchar(10) DEFAULT NULL,
  `Div1AirportID` int(11) DEFAULT NULL,
  `Div1AirportSeqID` int(11) DEFAULT NULL,
  `Div1WheelsOn` varchar(10) DEFAULT NULL,
  `Div1TotalGTime` varchar(10) DEFAULT NULL,
  `Div1LongestGTime` varchar(10) DEFAULT NULL,
  `Div1WheelsOff` varchar(10) DEFAULT NULL,
  `Div1TailNum` varchar(10) DEFAULT NULL,
  `Div2Airport` varchar(10) DEFAULT NULL,
  `Div2AirportID` int(11) DEFAULT NULL,
  `Div2AirportSeqID` int(11) DEFAULT NULL,
  `Div2WheelsOn` varchar(10) DEFAULT NULL,
  `Div2TotalGTime` varchar(10) DEFAULT NULL,
  `Div2LongestGTime` varchar(10) DEFAULT NULL,
  `Div2WheelsOff` varchar(10) DEFAULT NULL,
  `Div2TailNum` varchar(10) DEFAULT NULL,
  `Div3Airport` varchar(10) DEFAULT NULL,
  `Div3AirportID` int(11) DEFAULT NULL,
  `Div3AirportSeqID` int(11) DEFAULT NULL,
  `Div3WheelsOn` varchar(10) DEFAULT NULL,
  `Div3TotalGTime` varchar(10) DEFAULT NULL,
  `Div3LongestGTime` varchar(10) DEFAULT NULL,
  `Div3WheelsOff` varchar(10) DEFAULT NULL,
  `Div3TailNum` varchar(10) DEFAULT NULL,
  `Div4Airport` varchar(10) DEFAULT NULL,
  `Div4AirportID` int(11) DEFAULT NULL,
  `Div4AirportSeqID` int(11) DEFAULT NULL,
  `Div4WheelsOn` varchar(10) DEFAULT NULL,
  `Div4TotalGTime` varchar(10) DEFAULT NULL,
  `Div4LongestGTime` varchar(10) DEFAULT NULL,
  `Div4WheelsOff` varchar(10) DEFAULT NULL,
  `Div4TailNum` varchar(10) DEFAULT NULL,
  `Div5Airport` varchar(10) DEFAULT NULL,
  `Div5AirportID` int(11) DEFAULT NULL,
  `Div5AirportSeqID` int(11) DEFAULT NULL,
  `Div5WheelsOn` varchar(10) DEFAULT NULL,
  `Div5TotalGTime` varchar(10) DEFAULT NULL,
  `Div5LongestGTime` varchar(10) DEFAULT NULL,
  `Div5WheelsOff` varchar(10) DEFAULT NULL,
  `Div5TailNum` varchar(10) DEFAULT NULL,
  `timestamp_tidb` timestamp default current_timestamp
) DEFAULT CHARSET=latin1 ;

CREATE TABLE `ontime` (
   id bigint primary key, 
  `Year` year(4) DEFAULT NULL,
  `Quarter` tinyint(4) DEFAULT NULL,
  `Month` tinyint(4) DEFAULT NULL,
  `DayofMonth` tinyint(4) DEFAULT NULL,
  `DayOfWeek` tinyint(4) DEFAULT NULL,
  `FlightDate` date DEFAULT NULL,
  `UniqueCarrier` char(7) DEFAULT NULL,
  `AirlineID` int(11) DEFAULT NULL,
  `Carrier` char(2) DEFAULT NULL,
  `TailNum` varchar(50) DEFAULT NULL,
  `FlightNum` varchar(10) DEFAULT NULL,
  `OriginAirportID` int(11) DEFAULT NULL,
  `OriginAirportSeqID` int(11) DEFAULT NULL,
  `OriginCityMarketID` int(11) DEFAULT NULL,
  `Origin` char(5) DEFAULT NULL,
  `OriginCityName` varchar(100) DEFAULT NULL,
  `OriginState` char(2) DEFAULT NULL,
  `OriginStateFips` varchar(10) DEFAULT NULL,
  `OriginStateName` varchar(100) DEFAULT NULL,
  `OriginWac` int(11) DEFAULT NULL,
  `DestAirportID` int(11) DEFAULT NULL,
  `DestAirportSeqID` int(11) DEFAULT NULL,
  `DestCityMarketID` int(11) DEFAULT NULL,
  `Dest` char(5) DEFAULT NULL,
  `DestCityName` varchar(100) DEFAULT NULL,
  `DestState` char(2) DEFAULT NULL,
  `DestStateFips` varchar(10) DEFAULT NULL,
  `DestStateName` varchar(100) DEFAULT NULL,
  `DestWac` int(11) DEFAULT NULL,
  `CRSDepTime` int(11) DEFAULT NULL,
  `DepTime` int(11) DEFAULT NULL,
  `DepDelay` int(11) DEFAULT NULL,
  `DepDelayMinutes` int(11) DEFAULT NULL,
  `DepDel15` int(11) DEFAULT NULL,
  `DepartureDelayGroups` int(11) DEFAULT NULL,
  `DepTimeBlk` varchar(20) DEFAULT NULL,
  `TaxiOut` int(11) DEFAULT NULL,
  `WheelsOff` int(11) DEFAULT NULL,
  `WheelsOn` int(11) DEFAULT NULL,
  `TaxiIn` int(11) DEFAULT NULL,
  `CRSArrTime` int(11) DEFAULT NULL,
  `ArrTime` int(11) DEFAULT NULL,
  `ArrDelay` int(11) DEFAULT NULL,
  `ArrDelayMinutes` int(11) DEFAULT NULL,
  `ArrDel15` int(11) DEFAULT NULL,
  `ArrivalDelayGroups` int(11) DEFAULT NULL,
  `ArrTimeBlk` varchar(20) DEFAULT NULL,
  `Cancelled` tinyint(4) DEFAULT NULL,
  `CancellationCode` char(1) DEFAULT NULL,
  `Diverted` tinyint(4) DEFAULT NULL,
  `CRSElapsedTime` int(11) DEFAULT NULL,
  `ActualElapsedTime` int(11) DEFAULT NULL,
  `AirTime` int(11) DEFAULT NULL,
  `Flights` int(11) DEFAULT NULL,
  `Distance` int(11) DEFAULT NULL,
  `DistanceGroup` tinyint(4) DEFAULT NULL,
  `CarrierDelay` int(11) DEFAULT NULL,
  `WeatherDelay` int(11) DEFAULT NULL,
  `NASDelay` int(11) DEFAULT NULL,
  `SecurityDelay` int(11) DEFAULT NULL,
  `LateAircraftDelay` int(11) DEFAULT NULL,
  `FirstDepTime` varchar(10) DEFAULT NULL,
  `TotalAddGTime` varchar(10) DEFAULT NULL,
  `LongestAddGTime` varchar(10) DEFAULT NULL,
  `DivAirportLandings` varchar(10) DEFAULT NULL,
  `DivReachedDest` varchar(10) DEFAULT NULL,
  `DivActualElapsedTime` varchar(10) DEFAULT NULL,
  `DivArrDelay` varchar(10) DEFAULT NULL,
  `DivDistance` varchar(10) DEFAULT NULL,
  `Div1Airport` varchar(10) DEFAULT NULL,
  `Div1AirportID` int(11) DEFAULT NULL,
  `Div1AirportSeqID` int(11) DEFAULT NULL,
  `Div1WheelsOn` varchar(10) DEFAULT NULL,
  `Div1TotalGTime` varchar(10) DEFAULT NULL,
  `Div1LongestGTime` varchar(10) DEFAULT NULL,
  `Div1WheelsOff` varchar(10) DEFAULT NULL,
  `Div1TailNum` varchar(10) DEFAULT NULL,
  `Div2Airport` varchar(10) DEFAULT NULL,
  `Div2AirportID` int(11) DEFAULT NULL,
  `Div2AirportSeqID` int(11) DEFAULT NULL,
  `Div2WheelsOn` varchar(10) DEFAULT NULL,
  `Div2TotalGTime` varchar(10) DEFAULT NULL,
  `Div2LongestGTime` varchar(10) DEFAULT NULL,
  `Div2WheelsOff` varchar(10) DEFAULT NULL,
  `Div2TailNum` varchar(10) DEFAULT NULL,
  `Div3Airport` varchar(10) DEFAULT NULL,
  `Div3AirportID` int(11) DEFAULT NULL,
  `Div3AirportSeqID` int(11) DEFAULT NULL,
  `Div3WheelsOn` varchar(10) DEFAULT NULL,
  `Div3TotalGTime` varchar(10) DEFAULT NULL,
  `Div3LongestGTime` varchar(10) DEFAULT NULL,
  `Div3WheelsOff` varchar(10) DEFAULT NULL,
  `Div3TailNum` varchar(10) DEFAULT NULL,
  `Div4Airport` varchar(10) DEFAULT NULL,
  `Div4AirportID` int(11) DEFAULT NULL,
  `Div4AirportSeqID` int(11) DEFAULT NULL,
  `Div4WheelsOn` varchar(10) DEFAULT NULL,
  `Div4TotalGTime` varchar(10) DEFAULT NULL,
  `Div4LongestGTime` varchar(10) DEFAULT NULL,
  `Div4WheelsOff` varchar(10) DEFAULT NULL,
  `Div4TailNum` varchar(10) DEFAULT NULL,
  `Div5Airport` varchar(10) DEFAULT NULL,
  `Div5AirportID` int(11) DEFAULT NULL,
  `Div5AirportSeqID` int(11) DEFAULT NULL,
  `Div5WheelsOn` varchar(10) DEFAULT NULL,
  `Div5TotalGTime` varchar(10) DEFAULT NULL,
  `Div5LongestGTime` varchar(10) DEFAULT NULL,
  `Div5WheelsOff` varchar(10) DEFAULT NULL,
  `Div5TailNum` varchar(10) DEFAULT NULL,
  `timestamp_tidb` timestamp default current_timestamp,
  `timestamp_mysql` timestamp default current_timestamp
) DEFAULT CHARSET=latin1 ;

CREATE TABLE tidbtest.test.ontime (
  id bigint primary key,
  Year int DEFAULT NULL,
  Quarter tinyint DEFAULT NULL,
  Month tinyint DEFAULT NULL,
  DayofMonth tinyint DEFAULT NULL,
  DayOfWeek tinyint DEFAULT NULL,
  FlightDate date DEFAULT NULL,
  UniqueCarrier char(7) DEFAULT NULL,
  AirlineID int DEFAULT NULL,
  Carrier char(2) DEFAULT NULL,
  TailNum varchar(50) DEFAULT NULL,
  FlightNum varchar(10) DEFAULT NULL,
  OriginAirportID int DEFAULT NULL,
  OriginAirportSeqID int DEFAULT NULL,
  OriginCityMarketID int DEFAULT NULL,
  Origin char(5) DEFAULT NULL,
  OriginCityName varchar(100) DEFAULT NULL,
  OriginState char(2) DEFAULT NULL,
  OriginStateFips varchar(10) DEFAULT NULL,
  OriginStateName varchar(100) DEFAULT NULL,
  OriginWac int DEFAULT NULL,
  DestAirportID int DEFAULT NULL,
  DestAirportSeqID int DEFAULT NULL,
  DestCityMarketID int DEFAULT NULL,
  Dest char(5) DEFAULT NULL,
  DestCityName varchar(100) DEFAULT NULL,
  DestState char(2) DEFAULT NULL,
  DestStateFips varchar(10) DEFAULT NULL,
  DestStateName varchar(100) DEFAULT NULL,
  DestWac int DEFAULT NULL,
  CRSDepTime int DEFAULT NULL,
  DepTime int DEFAULT NULL,
  DepDelay int DEFAULT NULL,
  DepDelayMinutes int DEFAULT NULL,
  DepDel15 int DEFAULT NULL,
  DepartureDelayGroups int DEFAULT NULL,
  DepTimeBlk varchar(20) DEFAULT NULL,
  TaxiOut int DEFAULT NULL,
  WheelsOff int DEFAULT NULL,
  WheelsOn int DEFAULT NULL,
  TaxiIn int DEFAULT NULL,
  CRSArrTime int DEFAULT NULL,
  ArrTime int DEFAULT NULL,
  ArrDelay int DEFAULT NULL,
  ArrDelayMinutes int DEFAULT NULL,
  ArrDel15 int DEFAULT NULL,
  ArrivalDelayGroups int DEFAULT NULL,
  ArrTimeBlk varchar(20) DEFAULT NULL,
  Cancelled tinyint DEFAULT NULL,
  CancellationCode char(1) DEFAULT NULL,
  Diverted tinyint DEFAULT NULL,
  CRSElapsedTime int DEFAULT NULL,
  ActualElapsedTime int DEFAULT NULL,
  AirTime int DEFAULT NULL,
  Flights int DEFAULT NULL,
  Distance int DEFAULT NULL,
  DistanceGroup tinyint DEFAULT NULL,
   CarrierDelay int DEFAULT NULL,
  WeatherDelay int DEFAULT NULL,
  NASDelay int DEFAULT NULL,
  SecurityDelay int DEFAULT NULL,
  LateAircraftDelay int DEFAULT NULL,
  FirstDepTime varchar(10) DEFAULT NULL,
  TotalAddGTime varchar(10) DEFAULT NULL,
  LongestAddGTime varchar(10) DEFAULT NULL,
  DivAirportLandings varchar(10) DEFAULT NULL,
  DivReachedDest varchar(10) DEFAULT NULL,
  DivActualElapsedTime varchar(10) DEFAULT NULL,
  DivArrDelay varchar(10) DEFAULT NULL,
  DivDistance varchar(10) DEFAULT NULL,
  Div1Airport varchar(10) DEFAULT NULL,
  Div1AirportID int DEFAULT NULL,
  Div1AirportSeqID int DEFAULT NULL,
  Div1WheelsOn varchar(10) DEFAULT NULL,
  Div1TotalGTime varchar(10) DEFAULT NULL,
  Div1LongestGTime varchar(10) DEFAULT NULL,
  Div1WheelsOff varchar(10) DEFAULT NULL,
  Div1TailNum varchar(10) DEFAULT NULL,
  Div2Airport varchar(10) DEFAULT NULL,
  Div2AirportID int DEFAULT NULL,
  Div2AirportSeqID int DEFAULT NULL,
  Div2WheelsOn varchar(10) DEFAULT NULL,
  Div2TotalGTime varchar(10) DEFAULT NULL,
  Div2LongestGTime varchar(10) DEFAULT NULL,
  Div2WheelsOff varchar(10) DEFAULT NULL,
  Div2TailNum varchar(10) DEFAULT NULL,
  Div3Airport varchar(10) DEFAULT NULL,
  Div3AirportID int DEFAULT NULL,
  Div3AirportSeqID int DEFAULT NULL,
  Div3WheelsOn varchar(10) DEFAULT NULL,
  Div3TotalGTime varchar(10) DEFAULT NULL,
  Div3LongestGTime varchar(10) DEFAULT NULL,
  Div3WheelsOff varchar(10) DEFAULT NULL,
  Div3TailNum varchar(10) DEFAULT NULL,
  Div4Airport varchar(10) DEFAULT NULL,
  Div4AirportID int DEFAULT NULL,
  Div4AirportSeqID int DEFAULT NULL,
  Div4WheelsOn varchar(10) DEFAULT NULL,
  Div4TotalGTime varchar(10) DEFAULT NULL,
  Div4LongestGTime varchar(10) DEFAULT NULL,
  Div4WheelsOff varchar(10) DEFAULT NULL,
  Div4TailNum varchar(10) DEFAULT NULL,
  Div5Airport varchar(10) DEFAULT NULL,
  Div5AirportID int DEFAULT NULL,
  Div5AirportSeqID int DEFAULT NULL,
  Div5WheelsOn varchar(10) DEFAULT NULL,
  Div5TotalGTime varchar(10) DEFAULT NULL,
  Div5LongestGTime varchar(10) DEFAULT NULL,
  Div5WheelsOff varchar(10) DEFAULT NULL,
  Div5TailNum varchar(10) DEFAULT NULL,
  timestamp_tidb datetime default null,
  timestamp_mysql datetime default null,
  timestamp_sqlserver datetime default GETDATE()
)
;

LOAD DATA LOCAL INFILE '... /On_Time_Reporting_Carrier_On_Time_Performance_2017_1_01.csv' INTO TABLE ontime FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\n' (Year, Quarter, Month, DayofMonth, DayOfWeek, FlightDate, UniqueCarrier, AirlineID, Carrier, TailNum, FlightNum, OriginAirportID, OriginAirportSeqID, OriginCityMarketID, Origin, OriginCityName, OriginState,     OriginStateFips, OriginStateName, OriginWac, DestAirportID, DestAirportSeqID, DestCityMarketID, Dest, DestCityName, DestState, DestStateFips, DestStateName, DestWac, CRSDepTime, DepTime, DepDelay,        DepDelayMinutes, DepDel15, DepartureDelayGroups, DepTimeBlk, TaxiOut, WheelsOff, WheelsOn, TaxiIn, CRSArrTime, ArrTime, ArrDelay, ArrDelayMinutes, ArrDel15, ArrivalDelayGroups, ArrTimeBlk, Cancelled,     CancellationCode, Diverted, CRSElapsedTime, ActualElapsedTime, AirTime, Flights, Distance, DistanceGroup, CarrierDelay, WeatherDelay, NASDelay, SecurityDelay, LateAircraftDelay, FirstDepTime,             TotalAddGTime, LongestAddGTime, DivAirportLandings, DivReachedDest, DivActualElapsedTime, DivArrDelay, DivDistance, Div1Airport, Div1AirportID, Div1AirportSeqID, Div1WheelsOn, Div1TotalGTime,             Div1LongestGTime, Div1WheelsOff, Div1TailNum, Div2Airport, Div2AirportID, Div2AirportSeqID, Div2WheelsOn, Div2TotalGTime, Div2LongestGTime, Div2WheelsOff, Div2TailNum, Div3Airport, Div3AirportID,         Div3AirportSeqID, Div3WheelsOn, Div3TotalGTime, Div3LongestGTime, Div3WheelsOff, Div3TailNum, Div4Airport, Div4AirportID, Div4AirportSeqID, Div4WheelsOn, Div4TotalGTime, Div4LongestGTime, Div4WheelsOff,  Div4TailNum, Div5Airport, Div5AirportID, Div5AirportSeqID, Div5WheelsOn, Div5TotalGTime, Div5LongestGTime, Div5WheelsOff, Div5TailNum );
#+END_SRC


** Server spec

   | Component    | Instance Name | CPU | Memory | Comment            |
   |--------------+---------------+-----+--------+--------------------|
   | RDS - Aurora | db.r5.large   |   2 |     16 | Master - Slave     |
   | SQL Server   | t2.medium     |   2 |      4 |                    |
   | TiDB Node    | t2.xlarge     |   4 |     16 | TiDB/TiKV/PD/TiCDC |
** Peformance
*** test 

#+BEGIN_SRC
select distinct 
--timestamp_tidb, timestamp_mysql, timestamp_sqlserver,
  count(*)
, max(CAST(Datediff(s, '2020-01-01', timestamp_mysql    ) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_tidb ) AS BIGINT))          as max_cdc_latency
, max(CAST(Datediff(s, '2020-01-01', timestamp_sqlserver) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_mysql) AS BIGINT))          as max_dms_latency
, max(CAST(Datediff(s, '2020-01-01', timestamp_sqlserver) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_tidb ) AS BIGINT))          as max_time_latency
, sum(CAST(Datediff(s, '2020-01-01', timestamp_mysql    ) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_tidb ) AS BIGINT))/COUNT(*) as avg_cdc_latency
, sum(CAST(Datediff(s, '2020-01-01', timestamp_sqlserver) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_mysql) AS BIGINT))/COUNT(*) as avg_dms_latency
, sum(CAST(Datediff(s, '2020-01-01', timestamp_sqlserver) AS BIGINT) - CAST(Datediff(s, '2020-01-01', timestamp_tidb ) AS BIGINT))/COUNT(*) as avg_time_latency
   from tidbtest.test.ontime;
#+END_SRC
         | rows/tps | Thread | count | Max TiCDC latency | Max DMS latency | Max latency | Avg TiCDC latency | Avg DMS latency | Avg latency | TiCDC QPS |  QPS |
         |----------+--------+-------+-------------------+-----------------+-------------+-------------------+-----------------+-------------+-----------+------|
         |      100 |      1 |   200 |                 3 |              29 |          32 |                 2 |              15 |          17 |     10000 | 1176 |
         |      100 |      1 |   400 |                 3 |              59 |          61 |                 0 |              31 |          32 |         - | 1250 |
         |    10000 |      1 |     5 |                 8 |              79 |          86 |                 4 |              40 |          44 |     12500 | 1136 |
         |    10000 |      1 |    10 |                 8 |             149 |         156 |                 4 |              75 |          80 |     25000 | 1250 |

   
